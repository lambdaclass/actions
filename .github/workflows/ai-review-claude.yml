# Reusable workflow for Claude (Anthropic) code review
# Reference: https://github.com/anthropics/claude-code-action
# Usage: See examples/ai-review-caller.yml

name: Claude Code Review

on:
  workflow_call:
    inputs:
      model:
        description: 'Claude model to use (sonnet, opus, haiku)'
        required: false
        type: string
        default: 'sonnet'
      max_turns:
        description: 'Maximum agentic turns'
        required: false
        type: number
        default: 30
      prompt:
        description: 'Custom review prompt for Claude'
        required: false
        type: string
        default: |
          Please review this pull request with a focus on:

          1. **Security vulnerabilities** - Label by criticality (Critical/High/Medium/Low)
             - Solidity: e.g. reentrancy, access control, integer issues, etc.
             - Rust: e.g. unsafe blocks, error handling, panics, etc.
             - Web/API: e.g. SQL injection, auth bypass, input validation, sensitive data exposure, CORS/CSRF, etc.

          2. **Potential bugs** - Logic errors, edge cases, incorrect behavior, race conditions

          3. **Performance issues** - Only significant: e.g. O(nÂ²) on unbounded input, N+1 queries, unbounded memory growth

          4. **Simplicity** - Prefer simple, readable code over clever abstractions

          Guidelines:
          - Be concise and to the point
          - Do NOT suggest micro-optimizations or premature abstractions
          - Always prefer simplicity over complexity when performance gains are marginal
          - Focus on real issues, not hypothetical improvements
          - Be concise and actionable

          Note: The PR branch is already checked out in the current working directory.

          How to comment:
          Use `gh pr comment` for top-level feedback.
          Use `mcp__github_inline_comment__create_inline_comment` to highlight specific code issues.
          Only post GitHub comments - don't submit review text as messages.

          If no issues found, say so briefly.
      allowed_tools:
        description: 'Allowed tools for Claude (comma-separated)'
        required: false
        type: string
        default: 'mcp__github_inline_comment__create_inline_comment,Bash(gh pr view:*),Bash(gh pr diff:*),Bash(gh pr comment:*),Bash(cargo tree:*),Bash(cargo metadata:*),Bash(npm list:*),Bash(npm ls:*),Bash(forge inspect:*),Read,Glob,Grep'
    secrets:
      ANTHROPIC_API_KEY:
        description: 'Anthropic API key'
        required: true

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          show_full_output: true
          claude_args: |
            --model ${{ inputs.model }}
            --max-turns ${{ inputs.max_turns }}
            --allowedTools "${{ inputs.allowed_tools }}"
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            ${{ inputs.prompt }}
