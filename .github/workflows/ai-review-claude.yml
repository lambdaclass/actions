# Reusable workflow for Claude (Anthropic) code review
# Reference: https://github.com/anthropics/claude-code-action
# Usage: See examples/ai-review-caller.yml

name: Claude Code Review

on:
  workflow_call:
    inputs:
      model:
        description: 'Claude model to use (sonnet, opus, haiku)'
        required: false
        type: string
        default: 'sonnet'
      max_turns:
        description: 'Maximum agentic turns'
        required: false
        type: number
        default: 30
      prompt:
        description: 'Custom review prompt for Claude'
        required: false
        type: string
        default: |
          Review this pull request focusing on:
          1. **Security vulnerabilities** - Label by criticality (Critical/High/Medium/Low)
          2. **Bugs** - Logic errors, edge cases, incorrect behavior
          3. **Significant performance issues** - Only flag obvious problems like O(nÂ²) loops on large inputs

          Guidelines:
          - Be concise and actionable
          - Reference specific file names and line numbers
          - Only flag real issues, not style preferences
          - If no issues found, say so briefly

          The PR branch is already checked out. Use `gh pr comment` for top-level feedback and `mcp__github_inline_comment__create_inline_comment` for inline comments.
      allowed_tools:
        description: 'Allowed tools for Claude (comma-separated)'
        required: false
        type: string
        default: 'mcp__github_inline_comment__create_inline_comment,Bash(gh pr view:*),Bash(gh pr diff:*),Bash(gh pr comment:*),Bash(cargo tree:*),Bash(cargo metadata:*),Bash(npm list:*),Bash(npm ls:*),Bash(forge inspect:*),Read,Glob,Grep'
    secrets:
      ANTHROPIC_API_KEY:
        description: 'Anthropic API key'
        required: true

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          show_full_output: true
          claude_args: |
            --model ${{ inputs.model }}
            --max-turns ${{ inputs.max_turns }}
            --allowedTools "${{ inputs.allowed_tools }}"
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            ${{ inputs.prompt }}
