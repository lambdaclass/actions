# Reusable workflow for Claude (Anthropic) code review
# Reference: https://github.com/anthropics/claude-code-action
# Usage: See examples/ai-review-caller.yml

name: Claude Code Review

on:
  workflow_call:
    inputs:
      model:
        description: 'Claude model to use (sonnet, opus, haiku)'
        required: false
        type: string
        default: 'sonnet'
      max_turns:
        description: 'Maximum agentic turns'
        required: false
        type: number
        default: 30
      prompt:
        description: 'Custom review prompt (overrides prompt file if provided)'
        required: false
        type: string
        default: ''
      allowed_tools:
        description: 'Allowed tools for Claude (comma-separated)'
        required: false
        type: string
        default: 'mcp__github_inline_comment__create_inline_comment,Bash(gh pr view:*),Bash(gh pr diff:*),Bash(gh pr comment:*),Bash(cargo tree:*),Bash(cargo metadata:*),Bash(npm list:*),Bash(npm ls:*),Bash(forge inspect:*),Read,Glob,Grep'
    secrets:
      ANTHROPIC_API_KEY:
        description: 'Anthropic API key'
        required: true

jobs:
  claude-review:
    # For pull_request: only run on same-repo PRs (not forks)
    # For issue_comment: only allow users with write access (OWNER, MEMBER, COLLABORATOR)
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && startsWith(github.event.comment.body, '/claude') && contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: ${{ github.event.pull_request.head.sha || format('refs/pull/{0}/head', github.event.issue.number) }}

      - name: Load prompt
        id: prompt
        env:
          INPUT_PROMPT: ${{ inputs.prompt }}
        run: |
          if [ -n "$INPUT_PROMPT" ]; then
            cat << 'PROMPT_EOF' > /tmp/prompt.txt
          ${{ inputs.prompt }}
          PROMPT_EOF
            echo "source=input" >> $GITHUB_OUTPUT
          elif [ -f ".github/prompts/ai-review.md" ]; then
            cat .github/prompts/ai-review.md > /tmp/prompt.txt
            echo "source=custom" >> $GITHUB_OUTPUT
          else
            cat << 'PROMPT_EOF' > /tmp/prompt.txt
          Review this pull request focusing on:
          1. **Security vulnerabilities** - Label by criticality (Critical/High/Medium/Low)
          2. **Bugs** - Logic errors, edge cases, incorrect behavior
          3. **Significant performance issues** - Only flag obvious problems like O(nÂ²) loops on large inputs

          Guidelines:
          - Be concise and actionable
          - Reference specific file names and line numbers
          - Only flag real issues, not style preferences
          - If no issues found, say so briefly
          PROMPT_EOF
            echo "source=default" >> $GITHUB_OUTPUT
          fi
          echo "content<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/prompt.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          show_full_output: true
          claude_args: |
            --model ${{ inputs.model }}
            --max-turns ${{ inputs.max_turns }}
            --allowedTools "${{ inputs.allowed_tools }}"
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number || github.event.issue.number }}

            ${{ steps.prompt.outputs.content }}

            Output your review findings in markdown format. Do NOT post a PR comment yourself - just output the review content.

      - name: Post review comment
        if: steps.claude-review.outputs.execution_file != ''
        uses: actions/github-script@v7
        env:
          EXECUTION_FILE: ${{ steps.claude-review.outputs.execution_file }}
          PROMPT_SOURCE: ${{ steps.prompt.outputs.source }}
        with:
          script: |
            const fs = require('fs');
            const execFile = process.env.EXECUTION_FILE;
            const source = process.env.PROMPT_SOURCE;
            const customPrompt = (source === 'custom' || source === 'input') ? ' Â· custom prompt' : '';

            if (!execFile || !fs.existsSync(execFile)) {
              console.log('No execution file found');
              return;
            }

            const data = JSON.parse(fs.readFileSync(execFile, 'utf8'));
            // Find the result message (last message with type "result")
            const resultMsg = data.filter(m => m.type === 'result').pop();
            const review = resultMsg?.result || '';

            if (review && review.trim() !== '') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request?.number || context.payload.issue?.number,
                body: `## ðŸ¤– Claude Code Review\n\n${review}\n\n---\n*Automated review by Claude (Anthropic)${customPrompt}*`
              });
            }
