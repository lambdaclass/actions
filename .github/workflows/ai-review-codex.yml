# Reusable workflow for OpenAI Codex code review
# Reference: https://github.com/openai/codex-action
# Usage: See examples/ai-review-caller.yml

name: Codex Code Review

on:
  workflow_call:
    inputs:
      prompt:
        description: 'Custom review prompt (overrides prompt file if provided)'
        required: false
        type: string
        default: ''
      safety_strategy:
        description: 'Codex safety strategy (drop-sudo, permissive, etc.)'
        required: false
        type: string
        default: 'drop-sudo'
    secrets:
      OPENAI_API_KEY:
        description: 'OpenAI API key'
        required: true

permissions:
  contents: read
  pull-requests: write

jobs:
  codex:
    name: Codex Code Review
    # For pull_request: only run on same-repo PRs (not forks)
    # For issue_comment: only allow users with write access (OWNER, MEMBER, COLLABORATOR)
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && startsWith(github.event.comment.body, '/codex') && contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association))
    runs-on: ubuntu-latest
    outputs:
      final_message: ${{ steps.codex.outputs.final-message }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.pull_request.number || github.event.issue.number }}/merge

      - name: Load prompt
        id: prompt
        run: |
          if [ -n "${{ inputs.prompt }}" ]; then
            PROMPT="${{ inputs.prompt }}"
          elif [ -f ".github/prompts/ai-review.md" ]; then
            PROMPT=$(cat .github/prompts/ai-review.md)
          else
            PROMPT="You are a code reviewer. Review ONLY the changes in this pull request diff, not the entire codebase.

          Focus on:
          1. **Security vulnerabilities** - Label by criticality (Critical/High/Medium/Low)
          2. **Bugs** - Logic errors, edge cases, incorrect behavior
          3. **Significant performance issues** - Only flag obvious problems

          Guidelines:
          - Be concise and actionable
          - Reference specific file names and line numbers
          - Only flag real issues, not style preferences
          - If no issues found, say so briefly"
          fi
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Pre-fetch base and head refs for the PR
        run: |
          git fetch --no-tags origin \
            ${{ github.event.pull_request.base.ref }} \
            +refs/pull/${{ github.event.pull_request.number || github.event.issue.number }}/head

      - name: Run Codex Code Review
        id: codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          safety-strategy: ${{ inputs.safety_strategy }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number || github.event.issue.number }}

            ${{ steps.prompt.outputs.content }}

            To see the PR changes, run: git diff ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }}

  post_feedback:
    runs-on: ubuntu-latest
    needs: codex
    if: needs.codex.outputs.final_message != ''
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: Report Codex feedback
        uses: actions/github-script@v7
        env:
          CODEX_FINAL_MESSAGE: ${{ needs.codex.outputs.final_message }}
        with:
          github-token: ${{ github.token }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request?.number || context.payload.issue?.number,
              body: `## ðŸ¤– Codex Code Review\n\n${process.env.CODEX_FINAL_MESSAGE}\n\n---\n*Automated review by OpenAI Codex*`,
            });
